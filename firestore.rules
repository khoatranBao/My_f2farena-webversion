rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Collection "users":
    // - Bất kỳ ai đã đăng nhập đều có thể đọc thông tin người dùng khác.
    // - Người dùng chỉ có thể tự cập nhật thông tin của chính mình.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow update: if request.auth.uid == userId;
      // Không ai được phép tạo hoặc xóa user trực tiếp từ client.
      allow create, delete: if false;
    }

    // Collection "admin_only_data":
    // - Chỉ những người dùng có token chứa claim `admin: true` mới được đọc/ghi.
    match /admin_only_data/{docId} {
      allow read, write: if request.auth.token.admin == true;
    }
    
    // Collection "chat_messages":
    // - Bất kỳ ai đã đăng nhập cũng có thể đọc và gửi tin nhắn.
    match /artifacts/default-app-id/public/data/chat_messages/{messageId} {
       allow read, create: if request.auth != null;
       // Chỉ người gửi tin mới được sửa/xóa (nếu cần)
       allow update, delete: if request.auth.uid == resource.data.userId;
    }

    // Mặc định: Chặn tất cả các truy cập khác
    match /{document=**} {
      allow read, write: if false;
    }
  }
}